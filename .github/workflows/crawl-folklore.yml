name: Crawl Wikipedia Folklore

on:
  schedule:
    # 6시간마다 실행 (UTC 0, 6, 12, 18시)
    - cron: '0 */6 * * *'
  workflow_dispatch: # 수동 트리거 가능

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Wikipedia crawler
        run: node scripts/crawl-wikipedia-folklore.mjs

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet lib/folklore-data.ts components/FolkloreMap.jsx; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add lib/folklore-data.ts components/FolkloreMap.jsx scripts/crawl-state.json
          CREATURE_COUNT=$(node -e "
            const fs = require('fs');
            const c = fs.readFileSync('lib/folklore-data.ts','utf8');
            const marker = 'export const FOLKLORE_DATA: CountryData[] = ';
            const s = c.indexOf(marker) + marker.length;
            let d=0,e=s;
            for(let i=s;i<c.length;i++){if(c[i]==='[')d++;if(c[i]===']'){d--;if(d===0){e=i+1;break;}}}
            const data=JSON.parse(c.substring(s,e));
            console.log(data.reduce((a,b)=>a+b.b.length,0));
          ")
          git commit -m "Auto-crawl: update folklore creatures (total: ${CREATURE_COUNT})"
          git push
